# This file was auto generated by Styx.
# Do not edit this file directly.

import typing
import pathlib
from styxdefs import *

DUAL_REGRESSION_METADATA = Metadata(
    id="946d04aabc6cfe8a8c03c1a4b8fae3e4b866f0c8.boutiques",
    name="dual_regression",
    package="fsl",
    container_image_tag="brainlife/fsl:6.0.4-patched2",
)


_DualRegressionParamsDictNoTag = typing.TypedDict('_DualRegressionParamsDictNoTag', {
    "group_ic_maps": InputPathType,
    "des_norm": float,
    "design_mat": InputPathType,
    "design_con": InputPathType,
    "n_perm": float,
    "thr_flag": bool,
    "output_directory": str,
    "input_files": list[InputPathType],
})
DualRegressionParamsDictTagged = typing.TypedDict('DualRegressionParamsDictTagged', {
    "@type": typing.Literal["fsl/dual_regression"],
    "group_ic_maps": InputPathType,
    "des_norm": float,
    "design_mat": InputPathType,
    "design_con": InputPathType,
    "n_perm": float,
    "thr_flag": bool,
    "output_directory": str,
    "input_files": list[InputPathType],
})
DualRegressionParamsDict = _DualRegressionParamsDictNoTag | DualRegressionParamsDictTagged


class DualRegressionOutputs(typing.NamedTuple):
    """
    Output object returned when calling `DualRegressionParamsDict(...)`.
    """
    root: OutputPathType
    """Output root folder. This is the root folder for all outputs."""
    stage1_output: OutputPathType
    """Output from stage 1 for each subject"""
    stage2_output: OutputPathType
    """Output from stage 2 for each subject"""
    stage3_output: OutputPathType
    """Output from stage 3 for each subject"""
    randomise_output: OutputPathType
    """Output of randomise"""


def dual_regression_params(
    group_ic_maps: InputPathType,
    des_norm: float,
    design_mat: InputPathType,
    design_con: InputPathType,
    n_perm: float,
    output_directory: str,
    input_files: list[InputPathType],
    thr_flag: bool = False,
) -> DualRegressionParamsDictTagged:
    """
    Build parameters.
    
    Args:
        group_ic_maps: 4D image containing spatial IC maps (melodic_IC) from\
            the whole-group ICA analysis.
        des_norm: 0 or 1 (1 is recommended). Whether to variance-normalise the\
            timecourses used as the stage-2 regressors.
        design_mat: Design matrix for final cross-subject modelling with\
            randomise.
        design_con: Design contrasts for final cross-subject modelling with\
            randomise.
        n_perm: Number of permutations for randomise; set to 1 for just raw\
            tstat output, set to 0 to not run randomise at all.
        output_directory: This directory will be created to hold all output and\
            logfiles.
        input_files: List of all subjects' preprocessed, standard-space 4D\
            datasets.
        thr_flag: Perform thresholded dual regression to obtain unbiased\
            timeseries for connectomics analyses (e.g., with FSLnets).
    Returns:
        Parameter dictionary
    """
    params = {
        "@type": "fsl/dual_regression",
        "group_ic_maps": group_ic_maps,
        "des_norm": des_norm,
        "design_mat": design_mat,
        "design_con": design_con,
        "n_perm": n_perm,
        "thr_flag": thr_flag,
        "output_directory": output_directory,
        "input_files": input_files,
    }
    return params


def dual_regression_validate(
    params: typing.Any,
) -> None:
    """
    Validate parameters. Throws an error if `params` is not a valid
    `DualRegressionParamsDict` object.
    
    Args:
        params: The parameters object to validate.
    """
    if params is None or not isinstance(params, dict):
        raise StyxValidationError(f'Params object has the wrong type \'{type(params)}\'')
    if params.get("group_ic_maps", None) is None:
        raise StyxValidationError("`group_ic_maps` must not be None")
    if not isinstance(params["group_ic_maps"], (pathlib.Path, str)):
        raise StyxValidationError(f'`group_ic_maps` has the wrong type: Received `{type(params.get("group_ic_maps", None))}` expected `InputPathType`')
    if params.get("des_norm", None) is None:
        raise StyxValidationError("`des_norm` must not be None")
    if not isinstance(params["des_norm"], (float, int)):
        raise StyxValidationError(f'`des_norm` has the wrong type: Received `{type(params.get("des_norm", None))}` expected `float`')
    if params.get("design_mat", None) is None:
        raise StyxValidationError("`design_mat` must not be None")
    if not isinstance(params["design_mat"], (pathlib.Path, str)):
        raise StyxValidationError(f'`design_mat` has the wrong type: Received `{type(params.get("design_mat", None))}` expected `InputPathType`')
    if params.get("design_con", None) is None:
        raise StyxValidationError("`design_con` must not be None")
    if not isinstance(params["design_con"], (pathlib.Path, str)):
        raise StyxValidationError(f'`design_con` has the wrong type: Received `{type(params.get("design_con", None))}` expected `InputPathType`')
    if params.get("n_perm", None) is None:
        raise StyxValidationError("`n_perm` must not be None")
    if not isinstance(params["n_perm"], (float, int)):
        raise StyxValidationError(f'`n_perm` has the wrong type: Received `{type(params.get("n_perm", None))}` expected `float`')
    if params.get("thr_flag", False) is None:
        raise StyxValidationError("`thr_flag` must not be None")
    if not isinstance(params["thr_flag"], bool):
        raise StyxValidationError(f'`thr_flag` has the wrong type: Received `{type(params.get("thr_flag", False))}` expected `bool`')
    if params.get("output_directory", None) is None:
        raise StyxValidationError("`output_directory` must not be None")
    if not isinstance(params["output_directory"], str):
        raise StyxValidationError(f'`output_directory` has the wrong type: Received `{type(params.get("output_directory", None))}` expected `str`')
    if params.get("input_files", None) is None:
        raise StyxValidationError("`input_files` must not be None")
    if not isinstance(params["input_files"], list):
        raise StyxValidationError(f'`input_files` has the wrong type: Received `{type(params.get("input_files", None))}` expected `list[InputPathType]`')
    for e in params["input_files"]:
        if not isinstance(e, (pathlib.Path, str)):
            raise StyxValidationError(f'`input_files` has the wrong type: Received `{type(params.get("input_files", None))}` expected `list[InputPathType]`')


def dual_regression_cargs(
    params: DualRegressionParamsDict,
    execution: Execution,
) -> list[str]:
    """
    Build command-line arguments from parameters.
    
    Args:
        params: The parameters.
        execution: The execution object for resolving input paths.
    Returns:
        Command-line arguments.
    """
    cargs = []
    cargs.append("dual_regression")
    cargs.append(execution.input_file(params.get("group_ic_maps", None)))
    cargs.append(str(params.get("des_norm", None)))
    cargs.append(execution.input_file(params.get("design_mat", None)))
    cargs.append(execution.input_file(params.get("design_con", None)))
    cargs.append(str(params.get("n_perm", None)))
    if params.get("thr_flag", False):
        cargs.append("--thr")
    cargs.append(params.get("output_directory", None))
    cargs.extend([execution.input_file(f) for f in params.get("input_files", None)])
    return cargs


def dual_regression_outputs(
    params: DualRegressionParamsDict,
    execution: Execution,
) -> DualRegressionOutputs:
    """
    Build outputs object containing output file paths and possibly stdout/stderr.
    
    Args:
        params: The parameters.
        execution: The execution object for resolving input paths.
    Returns:
        Outputs object.
    """
    ret = DualRegressionOutputs(
        root=execution.output_file("."),
        stage1_output=execution.output_file(params.get("output_directory", None) + "/dr_stage1_subject[SUBJECT_INDEX].nii.gz"),
        stage2_output=execution.output_file(params.get("output_directory", None) + "/dr_stage2_subject[SUBJECT_INDEX].nii.gz"),
        stage3_output=execution.output_file(params.get("output_directory", None) + "/dr_stage3_subject[SUBJECT_INDEX].nii.gz"),
        randomise_output=execution.output_file(params.get("output_directory", None) + "/dr_randomise"),
    )
    return ret


def dual_regression_execute(
    params: DualRegressionParamsDict,
    runner: Runner | None = None,
) -> DualRegressionOutputs:
    """
    dual_regression
    
    Dual regression algorithm to investigate group-ICA results.
    
    Author: FMRIB Analysis Group, University of Oxford
    
    URL: https://fsl.fmrib.ox.ac.uk/fsl/fslwiki
    
    Args:
        params: The parameters.
        runner: Command runner.
    Returns:
        NamedTuple of outputs (described in `DualRegressionOutputs`).
    """
    dual_regression_validate(params)
    runner = runner or get_global_runner()
    execution = runner.start_execution(DUAL_REGRESSION_METADATA)
    params = execution.params(params)
    cargs = dual_regression_cargs(params, execution)
    ret = dual_regression_outputs(params, execution)
    execution.run(cargs)
    return ret


def dual_regression(
    group_ic_maps: InputPathType,
    des_norm: float,
    design_mat: InputPathType,
    design_con: InputPathType,
    n_perm: float,
    output_directory: str,
    input_files: list[InputPathType],
    thr_flag: bool = False,
    runner: Runner | None = None,
) -> DualRegressionOutputs:
    """
    dual_regression
    
    Dual regression algorithm to investigate group-ICA results.
    
    Author: FMRIB Analysis Group, University of Oxford
    
    URL: https://fsl.fmrib.ox.ac.uk/fsl/fslwiki
    
    Args:
        group_ic_maps: 4D image containing spatial IC maps (melodic_IC) from\
            the whole-group ICA analysis.
        des_norm: 0 or 1 (1 is recommended). Whether to variance-normalise the\
            timecourses used as the stage-2 regressors.
        design_mat: Design matrix for final cross-subject modelling with\
            randomise.
        design_con: Design contrasts for final cross-subject modelling with\
            randomise.
        n_perm: Number of permutations for randomise; set to 1 for just raw\
            tstat output, set to 0 to not run randomise at all.
        output_directory: This directory will be created to hold all output and\
            logfiles.
        input_files: List of all subjects' preprocessed, standard-space 4D\
            datasets.
        thr_flag: Perform thresholded dual regression to obtain unbiased\
            timeseries for connectomics analyses (e.g., with FSLnets).
        runner: Command runner.
    Returns:
        NamedTuple of outputs (described in `DualRegressionOutputs`).
    """
    params = dual_regression_params(
        group_ic_maps=group_ic_maps,
        des_norm=des_norm,
        design_mat=design_mat,
        design_con=design_con,
        n_perm=n_perm,
        thr_flag=thr_flag,
        output_directory=output_directory,
        input_files=input_files,
    )
    return dual_regression_execute(params, runner)


__all__ = [
    "DUAL_REGRESSION_METADATA",
    "DualRegressionOutputs",
    "DualRegressionParamsDict",
    "DualRegressionParamsDictTagged",
    "dual_regression",
    "dual_regression_execute",
    "dual_regression_params",
]
